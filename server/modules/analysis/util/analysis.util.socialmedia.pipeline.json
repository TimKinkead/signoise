[
    {
        "$match": {
            "$text": {
                "$search": "common core standards state english math science content curriculum ccss california #commoncore #ccss #stopcommoncore education teacher teachers student students school schools district districts classroom"
            },
            "date": {
                "$gte": "2016-02-01T08:00:00.000Z",
                "$lt": "2016-05-01T07:00:00.000Z"
            }
        }
    },
    {
        "$match": {
            "sentimentProcessed": {
                "$exists": true
            },
            "ngramsProcessed": {
                "$exists": true
            },
            "$or": [
                {
                    "ngrams.1.sorted.word": {
                        "$in": [
                            "ccss",
                            "commoncore",
                            "ccss",
                            "stopcommoncore",
                            "education",
                            "teacher",
                            "teachers",
                            "student",
                            "students",
                            "school",
                            "schools",
                            "classroom",
                            "classroom"
                        ]
                    }
                },
                {
                    "ngrams.2.sorted.word": {
                        "$in": [
                            "common core",
                            "state standards",
                            "content standards",
                            "core standards",
                            "curriculum standards",
                            "california standards",
                            "school district",
                            "school districts"
                        ]
                    }
                },
                {
                    "ngrams.3.sorted.word": {
                        "$in": [
                            "common core standards",
                            "common core english",
                            "common core math",
                            "common core science",
                            "california state standards",
                            "california common core"
                        ]
                    }
                },
                {
                    "ngrams.4.sorted.word": {
                        "$in": [
                            "common core state standards"
                        ]
                    }
                }
            ]
        }
    },
    {
        "$unwind": {
            "path": "$ngrams.1.sorted",
            "includeArrayIndex": "index1",
            "preserveNullAndEmptyArrays": true
        }
    },
    {
        "$project": {
            "data": [
                {
                    "sentiment": "$sentiment",
                    "gramSize": "$ngrams.1.gramSize",
                    "gramCount": "$ngrams.1.gramCount",
                    "word": "$ngrams.1.sorted.word",
                    "wordCount": "$ngrams.1.sorted.count",
                    "useForGrandTotals": {
                        "$cond": {
                            "if": {
                                "$eq": [
                                    "$index1",
                                    0
                                ]
                            },
                            "then": true,
                            "else": false
                        }
                    },
                    "useForNgramTotals": {
                        "$cond": {
                            "if": {
                                "$eq": [
                                    "$index1",
                                    0
                                ]
                            },
                            "then": true,
                            "else": false
                        }
                    }
                }
            ],
            "sentiment": true,
            "ngrams": {
                "$cond": {
                    "if": {
                        "$eq": [
                            "$index1",
                            0
                        ]
                    },
                    "then": "$ngrams",
                    "else": {
                        "$literal": {
                            "2": {
                                "sorted": [
                                    {
                                        "word": null,
                                        "count": 0
                                    }
                                ]
                            }
                        }
                    }
                }
            }
        }
    },
    {
        "$unwind": {
            "path": "$ngrams.2.sorted",
            "includeArrayIndex": "index2",
            "preserveNullAndEmptyArrays": true
        }
    },
    {
        "$project": {
            "data": {
                "$cond": {
                    "if": {
                        "$or": [
                            {
                                "$eq": [
                                    "$index2",
                                    0
                                ]
                            },
                            {
                                "$eq": [
                                    "$index2",
                                    null
                                ]
                            }
                        ]
                    },
                    "then": {
                        "$concatArrays": [
                            "$data",
                            [
                                {
                                    "sentiment": "$sentiment",
                                    "gramSize": "$ngrams.2.gramSize",
                                    "gramCount": "$ngrams.2.gramCount",
                                    "word": "$ngrams.2.sorted.word",
                                    "wordCount": "$ngrams.2.sorted.count",
                                    "useForGrandTotals": {
                                        "$literal": false
                                    },
                                    "useForNgramTotals": {
                                        "$literal": true
                                    }
                                }
                            ]
                        ]
                    },
                    "else": [
                        {
                            "sentiment": "$sentiment",
                            "gramSize": "$ngrams.2.gramSize",
                            "gramCount": "$ngrams.2.gramCount",
                            "word": "$ngrams.2.sorted.word",
                            "wordCount": "$ngrams.2.sorted.count",
                            "useForGrandTotals": {
                                "$literal": false
                            },
                            "useForNgramTotals": {
                                "$literal": false
                            }
                        }
                    ]
                }
            },
            "sentiment": true,
            "ngrams": {
                "$cond": {
                    "if": {
                        "$eq": [
                            "$index2",
                            0
                        ]
                    },
                    "then": "$ngrams",
                    "else": {
                        "$literal": {
                            "3": {
                                "sorted": [
                                    {
                                        "word": null,
                                        "count": 0
                                    }
                                ]
                            }
                        }
                    }
                }
            }
        }
    },
    {
        "$unwind": {
            "path": "$ngrams.3.sorted",
            "includeArrayIndex": "index3",
            "preserveNullAndEmptyArrays": true
        }
    },
    {
        "$project": {
            "data": {
                "$cond": {
                    "if": {
                        "$or": [
                            {
                                "$eq": [
                                    "$index3",
                                    0
                                ]
                            },
                            {
                                "$eq": [
                                    "$index3",
                                    null
                                ]
                            }
                        ]
                    },
                    "then": {
                        "$concatArrays": [
                            "$data",
                            [
                                {
                                    "sentiment": "$sentiment",
                                    "gramSize": "$ngrams.3.gramSize",
                                    "gramCount": "$ngrams.3.gramCount",
                                    "word": "$ngrams.3.sorted.word",
                                    "wordCount": "$ngrams.3.sorted.count",
                                    "useForGrandTotals": {
                                        "$literal": false
                                    },
                                    "useForNgramTotals": {
                                        "$literal": true
                                    }
                                }
                            ]
                        ]
                    },
                    "else": [
                        {
                            "sentiment": "$sentiment",
                            "gramSize": "$ngrams.3.gramSize",
                            "gramCount": "$ngrams.3.gramCount",
                            "word": "$ngrams.3.sorted.word",
                            "wordCount": "$ngrams.3.sorted.count",
                            "useForGrandTotals": {
                                "$literal": false
                            },
                            "useForNgramTotals": {
                                "$literal": false
                            }
                        }
                    ]
                }
            },
            "sentiment": true,
            "ngrams": {
                "$cond": {
                    "if": {
                        "$eq": [
                            "$index3",
                            0
                        ]
                    },
                    "then": "$ngrams",
                    "else": {
                        "$literal": {
                            "4": {
                                "sorted": [
                                    {
                                        "word": null,
                                        "count": 0
                                    }
                                ]
                            }
                        }
                    }
                }
            }
        }
    },
    {
        "$unwind": {
            "path": "$ngrams.4.sorted",
            "includeArrayIndex": "index4",
            "preserveNullAndEmptyArrays": true
        }
    },
    {
        "$project": {
            "data": {
                "$cond": {
                    "if": {
                        "$or": [
                            {
                                "$eq": [
                                    "$index4",
                                    0
                                ]
                            },
                            {
                                "$eq": [
                                    "$index4",
                                    null
                                ]
                            }
                        ]
                    },
                    "then": {
                        "$concatArrays": [
                            "$data",
                            [
                                {
                                    "sentiment": "$sentiment",
                                    "gramSize": "$ngrams.4.gramSize",
                                    "gramCount": "$ngrams.4.gramCount",
                                    "word": "$ngrams.4.sorted.word",
                                    "wordCount": "$ngrams.4.sorted.count",
                                    "useForGrandTotals": {
                                        "$literal": false
                                    },
                                    "useForNgramTotals": {
                                        "$literal": true
                                    }
                                }
                            ]
                        ]
                    },
                    "else": [
                        {
                            "sentiment": "$sentiment",
                            "gramSize": "$ngrams.4.gramSize",
                            "gramCount": "$ngrams.4.gramCount",
                            "word": "$ngrams.4.sorted.word",
                            "wordCount": "$ngrams.4.sorted.count",
                            "useForGrandTotals": {
                                "$literal": false
                            },
                            "useForNgramTotals": {
                                "$literal": false
                            }
                        }
                    ]
                }
            }
        }
    },
    {
        "$unwind": {
            "path": "$data"
        }
    },
    {
        "$project": {
            "data": true,
            "sentimentClass": {
                "$cond": {
                    "if": {
                        "$gte": [
                            "$data.sentiment",
                            0.03
                        ]
                    },
                    "then": "positive",
                    "else": {
                        "$cond": {
                            "if": {
                                "$lte": [
                                    "$data.sentiment",
                                    -0.03
                                ]
                            },
                            "then": "negative",
                            "else": "neutral"
                        }
                    }
                }
            }
        }
    },
    {
        "$group": {
            "_id": {
                "sentimentClass": "$sentimentClass",
                "gramSize": "$data.gramSize",
                "word": "$data.word"
            },
            "gramCount": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$eq": [
                                "$data.useForNgramTotals",
                                true
                            ]
                        },
                        "then": "$data.gramCount",
                        "else": 0
                    }
                }
            },
            "wordCount": {
                "$sum": "$data.wordCount"
            },
            "totalCount": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$eq": [
                                "$data.useForGrandTotals",
                                true
                            ]
                        },
                        "then": 1,
                        "else": 0
                    }
                }
            },
            "totalSentiment": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$eq": [
                                "$data.useForGrandTotals",
                                true
                            ]
                        },
                        "then": "$data.sentiment",
                        "else": 0
                    }
                }
            },
            "positiveSentiment": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$and": [
                                {
                                    "$eq": [
                                        "$data.useForGrandTotals",
                                        true
                                    ]
                                },
                                {
                                    "$gte": [
                                        "$data.sentiment",
                                        0.03
                                    ]
                                }
                            ]
                        },
                        "then": 1,
                        "else": 0
                    }
                }
            },
            "neutralSentiment": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$and": [
                                {
                                    "$eq": [
                                        "$data.useForGrandTotals",
                                        true
                                    ]
                                },
                                {
                                    "$gt": [
                                        "$data.sentiment",
                                        -0.03
                                    ]
                                },
                                {
                                    "$lt": [
                                        "$data.sentiment",
                                        0.03
                                    ]
                                }
                            ]
                        },
                        "then": 1,
                        "else": 0
                    }
                }
            },
            "negativeSentiment": {
                "$sum": {
                    "$cond": {
                        "if": {
                            "$and": [
                                {
                                    "$eq": [
                                        "$data.useForGrandTotals",
                                        true
                                    ]
                                },
                                {
                                    "$lte": [
                                        "$data.sentiment",
                                        -0.03
                                    ]
                                }
                            ]
                        },
                        "then": 1,
                        "else": 0
                    }
                }
            }
        }
    },
    {
        "$sort": {
            "wordCount": -1
        }
    },
    {
        "$group": {
            "_id": {
                "sentimentClass": "$_id.sentimentClass",
                "gramSize": "$_id.gramSize"
            },
            "totalCount": {
                "$sum": "$totalCount"
            },
            "totalSentiment": {
                "$sum": "$totalSentiment"
            },
            "positiveSentiment": {
                "$sum": "$positiveSentiment"
            },
            "neutralSentiment": {
                "$sum": "$neutralSentiment"
            },
            "negativeSentiment": {
                "$sum": "$negativeSentiment"
            },
            "totalGramCount": {
                "$sum": "$gramCount"
            },
            "ngrams": {
                "$push": {
                    "word": "$_id.word",
                    "count": "$wordCount"
                }
            }
        }
    },
    {
        "$project": {
            "_id": true,
            "totalCount": true,
            "totalSentiment": true,
            "positiveSentiment": true,
            "neutralSentiment": true,
            "negativeSentiment": true,
            "totalGramCount": true,
            "ngrams": {
                "$slice": [
                    "$ngrams",
                    100
                ]
            }
        }
    },
    {
        "$group": {
            "_id": "$_id.sentimentClass",
            "totalCount": {
                "$sum": "$totalCount"
            },
            "totalSentiment": {
                "$sum": "$totalSentiment"
            },
            "positiveSentiment": {
                "$sum": "$positiveSentiment"
            },
            "neutralSentiment": {
                "$sum": "$neutralSentiment"
            },
            "negativeSentiment": {
                "$sum": "$negativeSentiment"
            },
            "data": {
                "$push": {
                    "gramSize": "$_id.gramSize",
                    "totalGramCount": "$totalGramCount",
                    "ngrams": "$ngrams"
                }
            }
        }
    },
    {
        "$group": {
            "_id": null,
            "totalCount": {
                "$sum": "$totalCount"
            },
            "totalSentiment": {
                "$sum": "$totalSentiment"
            },
            "positiveSentiment": {
                "$sum": "$positiveSentiment"
            },
            "neutralSentiment": {
                "$sum": "$neutralSentiment"
            },
            "negativeSentiment": {
                "$sum": "$negativeSentiment"
            },
            "ngrams": {
                "$push": {
                    "sentimentClass": "$_id",
                    "data": "$data"
                }
            }
        }
    },
    {
        "$project": {
            "count": "$totalCount",
            "sentiment": {
                "average": {
                    "$cond": {
                        "if": {
                            "$gt": [
                                "$totalCount",
                                0
                            ]
                        },
                        "then": {
                            "$divide": [
                                "$totalSentiment",
                                "$totalCount"
                            ]
                        },
                        "else": null
                    }
                },
                "positive": "$positiveSentiment",
                "neutral": "$neutralSentiment",
                "negative": "$negativeSentiment"
            },
            "ngrams": true
        }
    }
]